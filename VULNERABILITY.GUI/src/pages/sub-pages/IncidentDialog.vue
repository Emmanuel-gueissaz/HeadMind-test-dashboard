<template lang="pug">
q-dialog(v-model='model')
  q-card( style='min-width:400px')
    q-card-section
      .text-h5.text-bold.text-primary {{t('IncidentDialog.title')}}
    q-card-section.row.items-center
      q-form.row.q-gutter-x-xs.q-gutter-y-sm(@submit='onSubmit', @reset='onReset')
        q-select.col-12(v-model='form.vulnerability.value',
        :options='vulnerabilityStore.vulnerability'
        :option-value='v => v ? v.id : null'
        :option-label='v => v ? v.title : undefined'
        map-options
        emit-value
        :label='t("IncidentDialog.vulnerability")'
        outlined
         :rules='[requiredRule]'
        )
        q-input.col-12(v-model='form.assignedTo.value', type='text', :label='t("IncidentDialog.assignedTo")' outlined :rules='[requiredRule]'
        )
        q-select.col-12(v-model='form.priority.value',
        :options='priority.map(e => ({id:e, label:t(`severity.${e}`)}))'
        :label='t("IncidentDialog.vulnerability")'
        option-value='id'
        :option-label='v => v ? v.label : ""'
        map-options
        emit-value
        outlined
        :rules='[requiredRule]')
        q-input.col-12(v-model='form.description.value', type='textarea', :label='t("IncidentDialog.description")' outlined :rules='[requiredRule]' )
        .row.justify-end.full-width.q-gutter-x-md
          q-btn(unelevated, :label='t("cancel")', type='reset', color='grey-9')
          q-btn( :label='t("create")', type='submit', color='primary')
</template>
<script setup lang="ts">
// Stores
import { useIncidentsStore } from 'src/stores/incident';
import { useVulnerabilityStore } from 'src/stores/vulnerability';
// Library
import { Notify } from 'quasar';
import { computed, ref } from 'vue';
import { useI18n } from 'vue-i18n';

// eslint-disable-next-line
const vulnerabilityStore = useVulnerabilityStore()
const incidentStore = useIncidentsStore()
const {t} = useI18n()

const props = defineProps<{
  modelValue:boolean
}>()

const emit = defineEmits(['update:modelValue'])

const form = {
  vulnerability:ref<string | null>(null),
  assignedTo:ref(''),
  priority:ref('HIGH'),
  description:ref(''),
}


// eslint-disable-next-line
const priority = ['HIGH','MEDIUM','LOW']

const model = computed({
  get:() => props.modelValue,
  set:(v) => emit('update:modelValue',v)
})

// eslint-disable-next-line
const onSubmit = () => {
  incidentStore.add({
    vulnerabilityId:form.vulnerability?.value ?? '',
    assignedTo:form.assignedTo.value,
    priority:form.priority.value,
    description:form.description.value,
    createdAt: new Date().toISOString(),
    id: `INC-${incidentStore.incidents.length.toString()}`
  })
  model.value = false
  Notify.create({message:t('success')})
}

// eslint-disable-next-line
const onReset = () => {
  model.value = false
}
// eslint-disable-next-line
const requiredRule = (v:any) => !!v || t('rules.required')
</script>

<style lang="">

</style>
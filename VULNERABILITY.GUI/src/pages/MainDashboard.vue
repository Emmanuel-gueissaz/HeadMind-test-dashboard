<template lang="pug">
.row.q-pa-md
  .q-pa-sm.col-md-3.col-sm-3.col-xs-6(v-for='s in severity' :key="s")
   DashboardIndicator(:indicator-value='vulnerabilityStore.counter(s)' :severity='s')
  .q-pa-sm.row.justify-between.full-width
    div
      BtnListToggle(:options='filterOptions' :model-value='selectedFilter' @update:modelValue='(v) => selectedFilter = v == null ? "ALL" : v')
    q-btn(color='primary', icon='add', :label='t("create")', @click='isDialogIncidentDisplay = true')
  .q-pa-sm.full-width
    q-card(bordered)
      q-table.radius.full-width(
        :title="t('MainDashBoard.title')"
        :rows="rows"
        :columns="columns"
        row-key="name"
        grid
      )
        template(v-slot:item='props' )
          VulnerabilityLine(:vulnerability='props.row')
IncidentDialog(v-model='isDialogIncidentDisplay')
</template>

<script setup lang="ts">
// Components
import DashboardIndicator from 'src/components/DashboardIndicator.vue';// eslint-disable-line
import VulnerabilityLine from 'src/components/VulnerabilityLine.vue';// eslint-disable-line
import BtnListToggle from 'src/components/BtnListToggle.vue';// eslint-disable-line
import IncidentDialog from 'src/pages/sub-pages/IncidentDialog.vue'; // eslint-disable-line
// Interfaces
import type { TSeverity } from 'src/interfaces/TSeverity.model';
import type { IVulnerability } from 'src/interfaces/IVulnerability.model';
// Stores
import { useVulnerabilityStore } from 'src/stores/vulnerability';
// Library
import { useI18n } from 'vue-i18n';
import { ref, watch } from 'vue';
import { useQuasar } from 'quasar';

const {t} = useI18n()

// eslint-disable-next-line
const q = useQuasar()

const vulnerabilityStore = useVulnerabilityStore()

const selectedFilter = ref('ALL')

const rows = ref<IVulnerability[]>(vulnerabilityStore.vulnerability)

const isDialogIncidentDisplay = ref(false) // eslint-disable-line

const severity:TSeverity[] = ['CRITICAL','HIGH','MEDIUM','LOW']
// eslint-disable-next-line
const columns = [
  { name: 'id', align: 'left', label:'' , field: 'id', sortable: false },
  { name: 'title', align: 'left', label:'' , field: 'title', sortable: false },
  { name: 'severity', align: 'left', label:'', field: 'severity', sortable: false },
  { name: 'system', align: 'left', label:'' , field: 'system', sortable: false },
  { name: 'description', align: 'left', label:'' , field: 'description', sortable: false },
  { name: 'status', align: 'left', label:'' , field: 'status', sortable: false },
  { name: 'cvssScore', align: 'left', label:'' , field: 'cvssScore', sortable: false }
]

// eslint-disable-next-line
const filterOptions = ref([
  {label:t('MainDashBoard.filter.ALL'),value:'ALL'},
  ...severity.map(s => ({label:t(`severity.${s}`),value:s}))
])

/**update list of vulnerability if filter or store vulnerability data change */
watch([selectedFilter,() => vulnerabilityStore.vulnerability],([newV]) => {
  if(newV === 'ALL' || newV == null)
    return rows.value = vulnerabilityStore.vulnerability
  rows.value = vulnerabilityStore.vulnerability.filter((e:IVulnerability) => e.severity === newV)
},{immediate:true})
</script>

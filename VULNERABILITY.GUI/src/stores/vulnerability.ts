import { defineStore } from 'pinia';
import { useStorage } from 'src/helpers/storage';
import type { IVulnerability } from 'src/interfaces/IVulnerability.model';
import type { TSeverity } from 'src/interfaces/TSeverity.model';
import { ref } from 'vue';

/**
 * Store the vulnerability
 */
export const useVulnerabilityStore = defineStore('vulnerability', () => {

  const {get,save} = useStorage<IVulnerability>('vulnerability')
  const vulnerability = ref<any[]>([]) // eslint-disable-line

  /**
   * Get counter by severity
   * @param severity
   * @returns number of vulnerability with the severity params
   */
  const counter = (severity:TSeverity) => vulnerability.value.filter((e:IVulnerability) => e.severity === severity).length

  /**
   * Update a vulnerability
   * @param value
   */
  const update = (value:IVulnerability) => {
    const index = vulnerability.value.findIndex(e => e.id === value.id)
    if(index !== -1)
      vulnerability.value[index] = value
    // save change
    save(vulnerability.value)
  }

  const init = () => {
    const data = get()
    console.log(data);

    if(data )
      vulnerability.value = data
    else
    void fetch('fakeVulnerability.json').then(async (res) =>vulnerability.value = JSON.parse(await res.text()))
  }
  init()


  return { vulnerability, counter, update }
})